<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BlackNote</title>
  <link rel="icon" type="image/png" href="/assets/BN.png" id="favicon">
  <link rel="stylesheet" href="/css/blacknote.css">
  
  <style>
    /* Homepage Specific Styles - Does not affect topbar */
    
    /* Reset and Base */
    .homepage-container {
      margin-top: 80px;
      min-height: calc(100vh - 80px);
      position: relative;
    }
    
    /* Main Layout */
    .main-layout {
      display: flex;
      width: 100%;
      min-height: calc(100vh - 80px);
      position: relative;
    }
    
    /* Left Sidebar - Profile */
    .left-sidebar {
      position: fixed;
      left: -320px;
      top: 80px;
      width: 320px;
      height: calc(100vh - 80px);
      background: rgba(26, 26, 26, 0.98);
      backdrop-filter: blur(10px);
      border-right: 1px solid #333;
      transition: left 0.3s ease;
      z-index: 100;
      overflow-y: auto;
      padding: 1.5rem;
    }
    
    .left-sidebar.open {
      left: 0;
    }
    
    .sidebar-toggle-left {
      position: fixed;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      background: #1DA1F2;
      border: none;
      color: white;
      padding: 1rem 0.5rem;
      cursor: pointer;
      border-radius: 0 8px 8px 0;
      z-index: 99;
      transition: all 0.3s;
      font-size: 1.2rem;
      box-shadow: 2px 0 8px rgba(0,0,0,0.3);
    }
    
    .sidebar-toggle-left:hover {
      background: #1a8cd8;
      padding-right: 0.7rem;
    }
    
    /* Profile Content */
    .profile-section {
      text-align: center;
    }
    
    .profile-pic {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      margin: 0 auto 1rem;
      background: linear-gradient(135deg, #1DA1F2, #0d8bd9);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      color: white;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.2s;
      overflow: hidden;
    }
    
    .profile-pic:hover {
      transform: scale(1.05);
    }
    
    .profile-name {
      font-size: 1.5rem;
      font-weight: 700;
      color: white;
      margin-bottom: 0.5rem;
    }
    
    .profile-bio {
      color: #888;
      margin-bottom: 1.5rem;
      font-size: 0.95rem;
      line-height: 1.4;
    }
    
    .edit-profile-btn {
      width: 100%;
      padding: 0.75rem;
      background: #1DA1F2;
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 1rem;
    }
    
    .edit-profile-btn:hover {
      background: #1a8cd8;
      transform: translateY(-2px);
    }
    
    /* Center Feed */
    .center-feed {
      flex: 1;
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem 1rem;
      min-height: calc(100vh - 80px);
    }
    
    /* Create Post */
    .create-post-compact {
      background: rgba(26, 26, 26, 0.98);
      backdrop-filter: blur(10px);
      border: 1px solid #333;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    .create-post-btn {
      width: 100%;
      padding: 1rem;
      background: linear-gradient(135deg, #1DA1F2, #0d8bd9);
      border: none;
      border-radius: 10px;
      color: white;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    
    .create-post-btn:hover {
      background: linear-gradient(135deg, #1a8cd8, #0c7ac4);
      transform: translateY(-2px);
    }
    
    /* Posts Feed */
    .posts-feed {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    
    .post-card {
      background: rgba(26, 26, 26, 0.98);
      backdrop-filter: blur(10px);
      border: 1px solid #333;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transition: transform 0.2s;
    }
    
    .post-card:hover {
      transform: translateY(-2px);
    }
    
    .post-header {
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      border-bottom: 1px solid #333;
    }
    
    .post-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #444;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      cursor: pointer;
      overflow: hidden;
    }
    
    .post-meta {
      flex: 1;
    }
    
    .post-author {
      color: white;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
    }
    
    .post-author:hover {
      color: #1DA1F2;
    }
    
    .post-time {
      color: #888;
      font-size: 0.85rem;
    }
    
    .post-menu-btn {
      background: none;
      border: none;
      color: #888;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 50%;
      transition: all 0.2s;
    }
    
    .post-menu-btn:hover {
      background: rgba(255,255,255,0.1);
      color: white;
    }
    
    .post-body {
      padding: 1.5rem;
      color: white;
      font-size: 1rem;
      line-height: 1.6;
      word-wrap: break-word;
    }
    
    .post-media {
      width: 100%;
      max-height: 600px;
      object-fit: contain;
      background: #000;
    }
    
    .post-actions {
      padding: 1rem 1.5rem;
      display: flex;
      gap: 1rem;
      border-top: 1px solid #333;
      flex-wrap: wrap;
    }
    
    .action-btn {
      background: none;
      border: 1px solid #444;
      color: #888;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
    }
    
    .action-btn:hover {
      background: rgba(255,255,255,0.05);
      border-color: #666;
      color: white;
    }
    
    .action-btn.active {
      background: #1DA1F2;
      border-color: #1DA1F2;
      color: white;
    }
    
    .toggle-comments-btn {
      background: none;
      border: 1px solid #1DA1F2;
      color: #1DA1F2;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      margin-left: auto;
    }
    
    .toggle-comments-btn:hover {
      background: #1DA1F2;
      color: white;
    }
    
    /* Right Sidebar - Comments */
    .right-sidebar {
      position: fixed;
      right: -400px;
      top: 80px;
      width: 400px;
      height: calc(100vh - 80px);
      background: rgba(26, 26, 26, 0.98);
      backdrop-filter: blur(10px);
      border-left: 1px solid #333;
      transition: right 0.3s ease;
      z-index: 100;
      display: flex;
      flex-direction: column;
    }
    
    .right-sidebar.open {
      right: 0;
    }
    
    .sidebar-toggle-right {
      position: fixed;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      background: #1DA1F2;
      border: none;
      color: white;
      padding: 1rem 0.5rem;
      cursor: pointer;
      border-radius: 8px 0 0 8px;
      z-index: 99;
      transition: all 0.3s;
      font-size: 1.2rem;
      box-shadow: -2px 0 8px rgba(0,0,0,0.3);
      display: none;
    }
    
    .sidebar-toggle-right.active {
      display: block;
    }
    
    .sidebar-toggle-right:hover {
      background: #1a8cd8;
      padding-left: 0.7rem;
    }
    
    .comments-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #333;
      color: white;
      font-weight: 600;
      font-size: 1.1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .close-comments {
      background: none;
      border: none;
      color: #888;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      border-radius: 50%;
    }
    
    .close-comments:hover {
      background: rgba(255,255,255,0.1);
      color: white;
    }
    
    .comments-content {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }
    
    .comment-item {
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #333;
    }
    
    .comment-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    
    .comment-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #444;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.85rem;
      overflow: hidden;
    }
    
    .comment-author {
      color: white;
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .comment-text {
      color: #ddd;
      margin-left: 2.5rem;
      font-size: 0.9rem;
      line-height: 1.4;
    }
    
    .comment-form {
      padding: 1rem;
      border-top: 1px solid #333;
      display: flex;
      gap: 0.5rem;
    }
    
    .comment-input {
      flex: 1;
      background: #2a2a2a;
      border: 1px solid #333;
      border-radius: 20px;
      padding: 0.75rem 1rem;
      color: white;
      font-size: 0.9rem;
    }
    
    .comment-input:focus {
      outline: none;
      border-color: #1DA1F2;
    }
    
    .comment-submit {
      background: #1DA1F2;
      border: none;
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }
    
    .comment-submit:hover {
      background: #1a8cd8;
    }
    
    /* Create Post Modal */
    .create-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    
    .create-modal.show {
      display: flex;
    }
    
    .modal-content {
      background: #1a1a1a;
      border-radius: 12px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-title {
      color: white;
      font-size: 1.5rem;
      font-weight: 700;
    }
    
    .modal-close {
      background: none;
      border: none;
      color: #888;
      font-size: 2rem;
      cursor: pointer;
      padding: 0;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-close:hover {
      background: rgba(255,255,255,0.1);
      color: white;
    }
    
    .modal-body {
      padding: 1.5rem;
    }
    
    .post-textarea {
      width: 100%;
      min-height: 150px;
      background: #2a2a2a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 1rem;
      color: white;
      font-size: 1rem;
      resize: vertical;
      font-family: inherit;
    }
    
    .post-textarea:focus {
      outline: none;
      border-color: #1DA1F2;
    }
    
    .media-upload-section {
      margin-top: 1rem;
      padding: 1rem;
      background: #2a2a2a;
      border-radius: 8px;
      border: 2px dashed #444;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .media-upload-section:hover {
      border-color: #1DA1F2;
      background: #333;
    }
    
    .media-upload-label {
      color: #888;
      font-size: 0.9rem;
    }
    
    .upload-progress {
      margin-top: 1rem;
      display: none;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #333;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: #1DA1F2;
      width: 0%;
      transition: width 0.3s;
    }
    
    .progress-text {
      color: #888;
      font-size: 0.85rem;
      margin-top: 0.5rem;
      text-align: center;
    }
    
    .modal-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid #333;
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
    }
    
    .modal-btn {
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .modal-btn-cancel {
      background: #2a2a2a;
      border: 1px solid #444;
      color: white;
    }
    
    .modal-btn-cancel:hover {
      background: #333;
    }
    
    .modal-btn-post {
      background: #1DA1F2;
      border: none;
      color: white;
    }
    
    .modal-btn-post:hover {
      background: #1a8cd8;
    }
    
    .modal-btn-post:disabled {
      background: #555;
      cursor: not-allowed;
      opacity: 0.5;
    }
    
    /* Profile Editor Modal */
    .profile-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    
    .profile-modal.show {
      display: flex;
    }
    
    .profile-form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .form-label {
      color: #888;
      font-size: 0.9rem;
      font-weight: 600;
    }
    
    .form-input {
      background: #2a2a2a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 0.75rem;
      color: white;
      font-size: 1rem;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #1DA1F2;
    }
    
    .form-textarea {
      background: #2a2a2a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 0.75rem;
      color: white;
      font-size: 1rem;
      min-height: 100px;
      resize: vertical;
      font-family: inherit;
    }
    
    .form-textarea:focus {
      outline: none;
      border-color: #1DA1F2;
    }
    
    .pfp-preview-container {
      text-align: center;
    }
    
    .pfp-preview {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      margin: 0 auto;
      object-fit: cover;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .pfp-preview:hover {
      transform: scale(1.05);
    }
    
    /* Empty State */
    .empty-feed {
      text-align: center;
      padding: 4rem 2rem;
      color: #888;
    }
    
    .empty-feed h2 {
      color: white;
      margin-bottom: 1rem;
    }
    
    /* Mobile Responsive */
    @media (max-width: 768px) {
      .center-feed {
        padding: 1rem 0.5rem;
      }
      
      .left-sidebar {
        width: 280px;
        left: -280px;
      }
      
      .right-sidebar {
        width: 100%;
        right: -100%;
      }
      
      .post-actions {
        flex-direction: column;
      }
      
      .toggle-comments-btn {
        margin-left: 0;
      }
      
      .sidebar-toggle-left,
      .sidebar-toggle-right {
        display: block;
      }
    }
    
    /* Scrollbar Styling */
    .left-sidebar::-webkit-scrollbar,
    .comments-content::-webkit-scrollbar,
    .modal-content::-webkit-scrollbar {
      width: 6px;
    }
    
    .left-sidebar::-webkit-scrollbar-track,
    .comments-content::-webkit-scrollbar-track,
    .modal-content::-webkit-scrollbar-track {
      background: #1a1a1a;
    }
    
    .left-sidebar::-webkit-scrollbar-thumb,
    .comments-content::-webkit-scrollbar-thumb,
    .modal-content::-webkit-scrollbar-thumb {
      background: #444;
      border-radius: 3px;
    }
    
    .left-sidebar::-webkit-scrollbar-thumb:hover,
    .comments-content::-webkit-scrollbar-thumb:hover,
    .modal-content::-webkit-scrollbar-thumb:hover {
      background: #666;
    }
    
    /* Loading Spinner */
    .loading {
      text-align: center;
      padding: 2rem;
      color: #888;
    }
    
    .spinner {
      border: 3px solid #333;
      border-top: 3px solid #1DA1F2;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="left-section">
      <button id="menuToggle" class="hamburger" aria-label="Open menu" aria-expanded="false" title="Menu">
        <span></span><span></span><span></span>
      </button>
      <a href="/pages/blacknote.html">
        <img src="/assets/blacknotetrans.png" alt="Logo" class="logo" />
      </a>
    </div>

    <div class="center-section">
      <div class="search-container">
        <input type="text" class="search-box" placeholder="Search..." />
      </div>
    </div>

    <div class="right-section">
      <a href="#" id="notification-bell-link" class="icon-btn" title="Notifications" style="margin-left: 15px; margin-right: 30px;">
        <img src="/assets/notif.png" alt="Notifications" class="custom-emoji">
      </a>
      <a href="/pages/blacknote.html" class="icon-btn" title="home">
        <img src="/assets/home.png" alt="home" class="custom-emoji">
      </a>
      <a href="/pages/friendsblacknote.html" class="icon-btn" title="Add">
        <img src="/assets/add.png" alt="Add" class="custom-emoji">
      </a>
      <a href="/pages/mapblacknote.html" class="icon-btn" title="Basketball">
        <img src="/assets/ball.png" alt="Basketball" class="custom-emoji">
      </a>
      <a href="/pages/dripblacknote.html" class="icon-btn" title="Black Market">
        <img src="/assets/shop.png" alt="Money" class="custom-emoji">
      </a>
      <a href="/pages/hollablacknote.html" class="icon-btn" title="Holla">
        <img src="/assets/hol.png" alt="Holla" class="custom-emoji">
      </a>
    </div>
  </header>

  <nav id="slideMenu" class="slide-menu" aria-hidden="true" role="navigation">
    <div class="slide-menu-inner" role="menu" aria-label="Site menu">
      <button id="contactBtn" class="menu-item" role="menuitem">Contact Us!</button>
      <button id="aboutBtn" class="menu-item" role="menuitem">About</button>
      <button id="logoutBtn" class="menu-item login-btn" role="menuitem">Logout</button>
    </div>
  </nav>
  <div id="menuOverlay" class="menu-overlay" aria-hidden="true"></div>

  <div id="offline-banner" class="offline-banner">You are offline ‚Äî some features may be unavailable.</div>

  <div class="homepage-container">
    <!-- Left Sidebar Toggle -->
    <button class="sidebar-toggle-left" id="toggleLeftSidebar">‚ò∞</button>

    <!-- Left Sidebar - Profile -->
    <aside class="left-sidebar" id="leftSidebar">
      <div class="profile-section">
        <div class="profile-pic" id="profilePic">?</div>
        <div class="profile-name" id="profileName">Guest</div>
        <div class="profile-bio" id="profileBio">Sign in to customize your profile</div>
        <button class="edit-profile-btn" id="editProfileBtn">Edit Profile</button>
      </div>
    </aside>

    <!-- Main Layout -->
    <div class="main-layout">
      <!-- Center Feed -->
      <main class="center-feed">
        <!-- Create Post -->
        <div class="create-post-compact">
          <button class="create-post-btn" id="openCreatePost">
            <span>‚úèÔ∏è</span>
            <span>Create Post</span>
          </button>
        </div>

        <!-- Posts Feed -->
        <div class="posts-feed" id="postsFeed">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading posts...</p>
          </div>
        </div>
      </main>
    </div>

    <!-- Right Sidebar Toggle -->
    <button class="sidebar-toggle-right" id="toggleRightSidebar">üí¨</button>

    <!-- Right Sidebar - Comments -->
    <aside class="right-sidebar" id="rightSidebar">
      <div class="comments-header">
        <span>Comments</span>
        <button class="close-comments" id="closeComments">&times;</button>
      </div>
      <div class="comments-content" id="commentsContent">
        <p style="color: #888; text-align: center; padding: 2rem;">Select a post to view comments</p>
      </div>
      <form class="comment-form" id="commentForm" style="display: none;">
        <input type="text" class="comment-input" id="commentInput" placeholder="Add a comment..." required>
        <button type="submit" class="comment-submit">Post</button>
      </form>
    </aside>
  </div>

  <!-- Create Post Modal -->
  <div class="create-modal" id="createModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Create Post</h2>
        <button class="modal-close" id="closeCreateModal">&times;</button>
      </div>
      <div class="modal-body">
        <textarea class="post-textarea" id="postText" placeholder="What's on your mind?"></textarea>
        
        <div class="media-upload-section" id="mediaUploadSection">
          <input type="file" id="mediaInput" accept="image/*,video/*" style="display: none;">
          <div class="media-upload-label">
            üìé Click to attach image or video (max 30MB after compression)
          </div>
          <div id="mediaPreview"></div>
        </div>
        
        <div class="upload-progress" id="uploadProgress">
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <div class="progress-text" id="progressText">Uploading...</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-cancel" id="cancelPost">Cancel</button>
        <button class="modal-btn modal-btn-post" id="submitPost">Post</button>
      </div>
    </div>
  </div>

  <!-- Profile Editor Modal -->
  <div class="profile-modal" id="profileModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Edit Profile</h2>
        <button class="modal-close" id="closeProfileModal">&times;</button>
      </div>
      <div class="modal-body">
        <form class="profile-form" id="profileForm">
          <div class="form-group pfp-preview-container">
            <label class="form-label">Profile Picture</label>
            <input type="file" id="pfpInput" accept="image/*" style="display: none;">
            <img src="/assets/BN.png" alt="Profile" class="pfp-preview" id="pfpPreview">
          </div>
          
          <div class="form-group">
            <label class="form-label" for="usernameInput">Username</label>
            <input type="text" class="form-input" id="usernameInput" placeholder="Enter username">
          </div>
          
          <div class="form-group">
            <label class="form-label" for="bioInput">Bio</label>
            <textarea class="form-textarea" id="bioInput" placeholder="Tell us about yourself..."></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-cancel" id="cancelProfile">Cancel</button>
        <button class="modal-btn modal-btn-post" id="saveProfile">Save Changes</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { 
      supabase, 
      uploadImageForUser, 
      onAuthStateChanged,
      getUserProfile,
      updateUserProfile
    } from '/javascript/supabase.js';

    // State
    let currentUser = null;
    let currentProfile = null;
    let posts = [];
    let currentPostForComments = null;
    let postsSubscription = null;

    // DOM Elements
    const leftSidebar = document.getElementById('leftSidebar');
    const rightSidebar = document.getElementById('rightSidebar');
    const toggleLeftBtn = document.getElementById('toggleLeftSidebar');
    const toggleRightBtn = document.getElementById('toggleRightSidebar');
    const closeCommentsBtn = document.getElementById('closeComments');
    const postsFeed = document.getElementById('postsFeed');
    const createModal = document.getElementById('createModal');
    const profileModal = document.getElementById('profileModal');
    const commentForm = document.getElementById('commentForm');
    const commentsContent = document.getElementById('commentsContent');

    // Toggle Sidebars
    toggleLeftBtn.addEventListener('click', () => {
      leftSidebar.classList.toggle('open');
    });

    closeCommentsBtn.addEventListener('click', () => {
      rightSidebar.classList.remove('open');
      toggleRightBtn.classList.remove('active');
    });

    // Create Post Modal
    document.getElementById('openCreatePost').addEventListener('click', () => {
      if (!currentUser) {
        alert('Please sign in to create posts');
        return;
      }
      createModal.classList.add('show');
    });

    document.getElementById('closeCreateModal').addEventListener('click', () => {
      createModal.classList.remove('show');
      resetCreateForm();
    });

    document.getElementById('cancelPost').addEventListener('click', () => {
      createModal.classList.remove('show');
      resetCreateForm();
    });

    // Media Upload with Compression
    const mediaInput = document.getElementById('mediaInput');
    const mediaUploadSection = document.getElementById('mediaUploadSection');
    const mediaPreview = document.getElementById('mediaPreview');
    let selectedMedia = null;

    mediaUploadSection.addEventListener('click', () => mediaInput.click());

    mediaInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const isVideo = file.type.startsWith('video/');
      const isImage = file.type.startsWith('image/');

      if (!isVideo && !isImage) {
        alert('Please upload an image or video file');
        return;
      }

      // Show preview and compress
      mediaPreview.innerHTML = '<p style="color: #888;">Processing...</p>';

      if (isImage) {
        selectedMedia = await compressImage(file);
        const url = URL.createObjectURL(selectedMedia);
        mediaPreview.innerHTML = `<img src="${url}" style="max-width: 100%; border-radius: 8px; margin-top: 1rem;">`;
      } else if (isVideo) {
        selectedMedia = await compressVideo(file);
        const url = URL.createObjectURL(selectedMedia);
        mediaPreview.innerHTML = `<video src="${url}" controls style="max-width: 100%; border-radius: 8px; margin-top: 1rem;"></video>`;
      }

      // Check size
      const sizeMB = selectedMedia.size / (1024 * 1024);
      if (sizeMB > 30) {
        alert('File is still too large after compression. Please choose a smaller file.');
        selectedMedia = null;
        mediaPreview.innerHTML = '';
        mediaInput.value = '';
      } else {
        mediaPreview.innerHTML += `<p style="color: #888; margin-top: 0.5rem;">Size: ${sizeMB.toFixed(2)} MB</p>`;
      }
    });

    // Image Compression
    async function compressImage(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;

            // Resize if too large
            const maxDimension = 1920;
            if (width > maxDimension || height > maxDimension) {
              if (width > height) {
                height = (height / width) * maxDimension;
                width = maxDimension;
              } else {
                width = (width / height) * maxDimension;
                height = maxDimension;
              }
            }

            canvas.width = width;
            canvas.height = height;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            canvas.toBlob((blob) => {
              resolve(new File([blob], file.name, { type: 'image/jpeg' }));
            }, 'image/jpeg', 0.8);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    // Video Compression (simplified - actual compression would require ffmpeg.wasm)
    async function compressVideo(file) {
      // For now, just return the file
      // In production, you'd want to use ffmpeg.wasm for actual compression
      return file;
    }

    // Submit Post
    document.getElementById('submitPost').addEventListener('click', async () => {
      const text = document.getElementById('postText').value.trim();
      
      if (!text && !selectedMedia) {
        alert('Please add some content to your post');
        return;
      }

      const submitBtn = document.getElementById('submitPost');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Posting...';

      try {
        let mediaUrl = null;

        if (selectedMedia) {
          // Upload media
          document.getElementById('uploadProgress').style.display = 'block';
          mediaUrl = await uploadMediaWithProgress(selectedMedia);
        }

        // Create post
        await supabase.from('posts').insert({
          author_uid: currentUser.id,
          author_name: currentProfile?.name || 'User',
          author_avatar: currentProfile?.pfp || null,
          body: text,
          image: mediaUrl,
          created_at: new Date().toISOString(),
          display_time: new Date().toLocaleString(),
          liked_by: [],
          disliked_by: [],
          comments: []
        });

        createModal.classList.remove('show');
        resetCreateForm();
      } catch (error) {
        console.error('Error creating post:', error);
        alert('Failed to create post');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Post';
      }
    });

    async function uploadMediaWithProgress(file) {
      const fileName = `${currentUser.id}/${Date.now()}_${file.name}`;
      
      const { data, error } = await supabase.storage
        .from('post-media')
        .upload(fileName, file);

      if (error) throw error;

      const { data: { publicUrl } } = supabase.storage
        .from('post-media')
        .getPublicUrl(fileName);

      return publicUrl;
    }

    function resetCreateForm() {
      document.getElementById('postText').value = '';
      mediaInput.value = '';
      mediaPreview.innerHTML = '';
      selectedMedia = null;
      document.getElementById('uploadProgress').style.display = 'none';
    }

    // Profile Editor
    document.getElementById('editProfileBtn').addEventListener('click', () => {
      if (!currentUser) {
        alert('Please sign in to edit your profile');
        return;
      }
      
      document.getElementById('usernameInput').value = currentProfile?.name || '';
      document.getElementById('bioInput').value = currentProfile?.bio || '';
      document.getElementById('pfpPreview').src = currentProfile?.pfp || '/assets/BN.png';
      
      profileModal.classList.add('show');
    });

    document.getElementById('closeProfileModal').addEventListener('click', () => {
      profileModal.classList.remove('show');
    });

    document.getElementById('cancelProfile').addEventListener('click', () => {
      profileModal.classList.remove('show');
    });

    document.getElementById('pfpPreview').addEventListener('click', () => {
      document.getElementById('pfpInput').click();
    });

    document.getElementById('pfpInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById('pfpPreview').src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    document.getElementById('saveProfile').addEventListener('click', async () => {
      if (!currentUser) return;

      const saveBtn = document.getElementById('saveProfile');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      try {
        const name = document.getElementById('usernameInput').value.trim();
        const bio = document.getElementById('bioInput').value.trim();
        
        let pfpUrl = currentProfile?.pfp;
        const pfpFile = document.getElementById('pfpInput').files[0];
        
        if (pfpFile) {
          pfpUrl = await uploadImageForUser(pfpFile, currentUser.id);
        }

        await updateUserProfile({
          displayName: name,
          username: name,
          bio: bio,
          pfpUrl: pfpUrl
        });

        profileModal.classList.remove('show');
      } catch (error) {
        console.error('Error saving profile:', error);
        alert('Failed to save profile');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Changes';
      }
    });

    // Render Posts
    function renderPosts(postsArray) {
      if (!postsArray || postsArray.length === 0) {
        postsFeed.innerHTML = `
          <div class="empty-feed">
            <h2>No Posts Yet</h2>
            <p>Be the first to share something!</p>
          </div>
        `;
        return;
      }

      postsFeed.innerHTML = postsArray.map(post => `
        <article class="post-card" data-post-id="${post.id}">
          <div class="post-header">
            <div class="post-avatar">
              ${post.author_avatar ? 
                `<img src="${post.author_avatar}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">` : 
                (post.author_name ? post.author_name[0].toUpperCase() : '?')}
            </div>
            <div class="post-meta">
              <a href="/pages/profileblacknote.html?user=${encodeURIComponent(post.author_name)}" class="post-author">
                ${post.author_name || 'Unknown'}
              </a>
              <div class="post-time">${post.display_time || new Date(post.created_at).toLocaleString()}</div>
            </div>
            ${currentUser && post.author_uid === currentUser.id ? `
              <button class="post-menu-btn" data-post-id="${post.id}">‚ãÆ</button>
            ` : ''}
          </div>
          
          ${post.body ? `<div class="post-body">${escapeHtml(post.body)}</div>` : ''}
          
          ${post.image ? `
            ${post.image.includes('.mp4') || post.image.includes('.webm') ? 
              `<video class="post-media" controls><source src="${post.image}"></video>` : 
              `<img class="post-media" src="${post.image}" alt="Post media">`}
          ` : ''}
          
          <div class="post-actions">
            <button class="action-btn like-btn ${post.liked_by?.includes(currentUser?.id) ? 'active' : ''}" data-post-id="${post.id}">
              üëç <span>${post.liked_by?.length || 0}</span>
            </button>
            <button class="action-btn dislike-btn ${post.disliked_by?.includes(currentUser?.id) ? 'active' : ''}" data-post-id="${post.id}">
              üëé <span>${post.disliked_by?.length || 0}</span>
            </button>
            <button class="toggle-comments-btn" data-post-id="${post.id}">
              üí¨ Comments (${post.comments?.length || 0})
            </button>
          </div>
        </article>
      `).join('');

      attachPostListeners();
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function attachPostListeners() {
      // Like buttons
      document.querySelectorAll('.like-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          if (!currentUser) {
            alert('Please sign in to like posts');
            return;
          }

          const postId = e.currentTarget.dataset.postId;
          const post = posts.find(p => p.id === postId);
          if (!post) return;

          const liked = post.liked_by || [];
          const disliked = post.disliked_by || [];
          const userId = currentUser.id;

          let newLiked, newDisliked;
          if (liked.includes(userId)) {
            newLiked = liked.filter(id => id !== userId);
            newDisliked = disliked;
          } else {
            newLiked = [...liked, userId];
            newDisliked = disliked.filter(id => id !== userId);
          }

          await supabase.from('posts').update({
            liked_by: newLiked,
            disliked_by: newDisliked
          }).eq('id', postId);
        });
      });

      // Dislike buttons
      document.querySelectorAll('.dislike-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          if (!currentUser) {
            alert('Please sign in to dislike posts');
            return;
          }

          const postId = e.currentTarget.dataset.postId;
          const post = posts.find(p => p.id === postId);
          if (!post) return;

          const liked = post.liked_by || [];
          const disliked = post.disliked_by || [];
          const userId = currentUser.id;

          let newLiked, newDisliked;
          if (disliked.includes(userId)) {
            newLiked = liked;
            newDisliked = disliked.filter(id => id !== userId);
          } else {
            newLiked = liked.filter(id => id !== userId);
            newDisliked = [...disliked, userId];
          }

          await supabase.from('posts').update({
            liked_by: newLiked,
            disliked_by: newDisliked
          }).eq('id', postId);
        });
      });

      // Toggle comments
      document.querySelectorAll('.toggle-comments-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const postId = e.currentTarget.dataset.postId;
          loadComments(postId);
          rightSidebar.classList.add('open');
          toggleRightBtn.classList.add('active');
        });
      });
    }

    // Load Comments
    function loadComments(postId) {
      const post = posts.find(p => p.id === postId);
      if (!post) return;

      currentPostForComments = postId;
      commentForm.style.display = 'flex';
      commentForm.dataset.postId = postId;

      if (!post.comments || post.comments.length === 0) {
        commentsContent.innerHTML = '<p style="color: #888; text-align: center; padding: 2rem;">No comments yet. Be the first!</p>';
        return;
      }

      commentsContent.innerHTML = post.comments.map(comment => `
        <div class="comment-item">
          <div class="comment-header">
            <div class="comment-avatar">
              ${comment.avatar ? 
                `<img src="${comment.avatar}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">` : 
                (comment.author ? comment.author[0].toUpperCase() : '?')}
            </div>
            <div class="comment-author">${comment.author || 'Unknown'}</div>
          </div>
          <div class="comment-text">${escapeHtml(comment.text)}</div>
        </div>
      `).join('');
    }

    // Comment Form
    commentForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (!currentUser) {
        alert('Please sign in to comment');
        return;
      }

      const input = document.getElementById('commentInput');
      const text = input.value.trim();
      if (!text) return;

      const postId = commentForm.dataset.postId;
      const post = posts.find(p => p.id === postId);
      if (!post) return;

      const newComment = {
        id: Date.now().toString(),
        author: currentProfile?.name || 'User',
        avatar: currentProfile?.pfp || null,
        authorUid: currentUser.id,
        text: text,
