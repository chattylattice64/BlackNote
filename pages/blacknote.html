<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BlackNote</title>
  <link rel="icon" type="image/png" href="/assets/BN.png" id="favicon">
  <link rel="stylesheet" href="/css/blacknote.css">
  
  <style>
    /* Background and body styling */
    body {
      background-color: #0a0a0a;
      background-image: url('/assets/background.gif'); /* Add your background gif path here */
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-repeat: no-repeat;
    }
    
    /* Profile picture styling */
    .profile-pic {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background-color: #2a2a2a;
      background-size: cover;
      background-position: center;
      border: 4px solid #1DA1F2;
      margin: 0 auto 1rem;
      cursor: pointer;
      transition: transform 0.2s;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    
    .profile-pic:hover {
      transform: scale(1.05);
    }
    
    /* Profile center styling */
    .profile-center {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 2rem 1.5rem;
    }
    
    .profile-name {
      font-size: 1.5rem;
      font-weight: 700;
      color: white;
      margin: 0.5rem 0;
    }
    
    .profile-bio {
      color: #888;
      font-size: 0.9rem;
      margin: 0.5rem 0 1rem;
      line-height: 1.4;
    }
    
    .edit-profile-btn {
      width: 100%;
      margin-top: 1rem;
    }
    
    /* Badge styles */
    .badge-container {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #333;
    }
    
    .badge-display {
      display: flex;
      justify-content: center;
      margin-bottom: 0.5rem;
    }
    
    .badge-icon {
      width: 64px;
      height: 64px;
      border-radius: 8px;
      object-fit: cover;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    /* Badge next to username in profile */
    .profile-header-with-badge {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      justify-content: center;
    }
    
    .profile-badge-small {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      object-fit: cover;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .badge-selector {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    .badge-option {
      width: 100%;
      aspect-ratio: 1;
      border: 2px solid transparent;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      overflow: hidden;
      background-size: cover;
      background-position: center;
    }
    
    .badge-option:hover {
      transform: scale(1.05);
      border-color: #666;
    }
    
    .badge-option.selected {
      border-color: #1DA1F2;
      box-shadow: 0 0 12px rgba(29, 161, 242, 0.5);
    }
    
    .badge-option.red { background-color: #ef4444; }
    .badge-option.gold { background-color: #fbbf24; }
    .badge-option.blue { background-color: #3b82f6; }
    .badge-option.green { background-color: #10b981; }
    .badge-option.white { background-color: #f3f4f6; }
    .badge-option.black { background-color: #1f2937; }
    .badge-option.pink { background-color: #ec4899; }
    
    /* Collapsible create post - NOW COMPACT BUTTON */
    .create-post-button-container {
      padding: 1rem;
      background: #1a1a1a;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      border: 1px solid #2a2a2a;
    }
    
    .create-post-compact-btn {
      width: 100%;
      padding: 1rem;
      background: linear-gradient(135deg, #1DA1F2, #0d8bd9);
      border: none;
      border-radius: 10px;
      color: white;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      box-shadow: 0 4px 12px rgba(29, 161, 242, 0.3);
    }
    
    .create-post-compact-btn:hover {
      background: linear-gradient(135deg, #1a8cd8, #0c7ac4);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(29, 161, 242, 0.4);
    }
    
    .create-post-compact-btn:active {
      transform: translateY(0);
    }
    
    /* Create Post Modal - FULLSCREEN */
    .create-post-modal {
      position: fixed;
      top: 80px;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      z-index: 10000;
      backdrop-filter: blur(8px);
      opacity: 0;
      transition: opacity 0.2s ease;
      pointer-events: none;
    }
    
    .create-post-modal.visible {
      opacity: 1;
      pointer-events: all;
    }
    
    .create-post-modal-content {
      background: #0a0a0a;
      width: 100%;
      height: 100%;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      transform: translateY(20px);
      transition: transform 0.2s ease;
    }
    
    .create-post-modal.visible .create-post-modal-content {
      transform: translateY(0);
    }
    
    .create-post-modal-header {
      padding: 1.5rem 2rem;
      border-bottom: 1px solid #333;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
      background: #1a1a1a;
    }
    
    .create-post-modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: white;
    }
    
    .create-post-close-btn {
      background: none;
      border: none;
      color: #888;
      font-size: 2rem;
      cursor: pointer;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .create-post-close-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }
    
    .create-post-modal-body {
      flex: 1;
      padding: 2rem;
      max-width: 800px;
      margin: 0 auto;
      width: 100%;
      display: flex;
      flex-direction: column;
    }
    
    .create-post-textarea {
      width: 100%;
      flex: 1;
      min-height: 300px;
      padding: 1.5rem;
      background: #1a1a1a;
      border: 2px solid #333;
      border-radius: 12px;
      color: white;
      font-size: 1.1rem;
      resize: none;
      transition: border-color 0.2s;
      font-family: inherit;
    }
    
    .create-post-textarea:focus {
      outline: none;
      border-color: #1DA1F2;
    }
    
    .create-post-media {
      margin: 1.5rem 0;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .media-upload-btn {
      padding: 0.75rem 1.5rem;
      background: #2a2a2a;
      border: 1px solid #444;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-block;
    }
    
    .media-upload-btn:hover {
      background: #333;
      border-color: #1DA1F2;
    }
    
    .file-name {
      color: #888;
      font-size: 0.9rem;
      flex: 1;
    }
    
    .remove-media-btn {
      padding: 0.5rem;
      background: #ef4444;
      border: none;
      border-radius: 6px;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
      display: none;
      width: 32px;
      height: 32px;
      align-items: center;
      justify-content: center;
    }
    
    .remove-media-btn:hover {
      background: #dc2626;
    }
    
    .create-post-actions {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      margin-top: 1.5rem;
    }
    
    .create-post-cancel-btn {
      padding: 0.75rem 1.5rem;
      background: #2a2a2a;
      border: 1px solid #444;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .create-post-cancel-btn:hover {
      background: #333;
    }
    
    .post-btn {
      padding: 0.75rem 2rem;
      background: #1DA1F2;
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .post-btn:hover {
      background: #1a8cd8;
    }
    
    .post-btn:disabled {
      background: #555;
      cursor: not-allowed;
      opacity: 0.5;
    }
    
    /* Friends under profile */
    .panel {
      background: #1a1a1a;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      border: 1px solid #2a2a2a;
      margin-bottom: 1rem;
    }
    
    .avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 1.2rem;
      flex-shrink: 0;
      overflow: hidden;
    }
    
    .left .friends-section {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .friends-section .panel {
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }
    
    .friends-section h3 {
      margin: 0 0 1rem 0;
      font-size: 1.25rem;
      font-weight: 700;
      flex-shrink: 0;
    }
    
    .friends-list {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding-right: 0.5rem;
    }
    
    .friends-list::-webkit-scrollbar {
      width: 6px;
    }
    
    .friends-list::-webkit-scrollbar-track {
      background: #1a1a1a;
      border-radius: 3px;
    }
    
    .friends-list::-webkit-scrollbar-thumb {
      background: #444;
      border-radius: 3px;
    }
    
    .friends-list::-webkit-scrollbar-thumb:hover {
      background: #666;
    }
    
    .left {
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
      max-height: calc(100vh - 80px);
      padding: 0;
      width: 420px; 
      min-width: 420px;
    }
    
    .left > .panel {
      flex-shrink: 0;
      margin: 0;
    }
    
    /* Friends section with max height */
    .left .friends-section {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    
    /* Friend item with 3-dot menu */
    .friend-item {
      position: relative;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      border-radius: 8px;
      transition: background-color 0.2s;
      margin-bottom: 0.5rem;
    }
    
    .friend-item:hover {
      background-color: rgba(255,255,255,0.05);
    }
    
    .friend-menu-btn {
      margin-left: auto;
      background: none;
      border: none;
      color: #888;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      transition: all 0.2s;
    }
    
    .friend-menu-btn:hover {
      background-color: rgba(255,255,255,0.1);
      color: #fff;
    }
    
    .friend-dropdown {
      position: absolute;
      right: 0;
      top: 100%;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 0.5rem;
      min-width: 150px;
      z-index: 100;
      display: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    
    .friend-dropdown.visible {
      display: block;
    }
    
    .friend-dropdown button {
      display: block;
      width: 100%;
      padding: 0.5rem 0.75rem;
      background: none;
      border: none;
      color: white;
      text-align: left;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.2s;
    }
    
    .friend-dropdown button:hover {
      background-color: rgba(255,255,255,0.1);
    }
    
    /* Scroll snap for posts */
    .feed {
      height: calc(100vh - 80px);
      overflow-y: scroll;
      scroll-snap-type: y mandatory;
      scrollbar-width: none;
      -ms-overflow-style: none;
      scroll-behavior: smooth;
    }
    
    .feed::-webkit-scrollbar {
      display: none;
    }
    
    .post {
      scroll-snap-align: start;
      scroll-snap-stop: always;
      min-height: calc(100vh - 80px);
      max-height: calc(100vh - 80px);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      margin-bottom: 0;
      padding: 1.5rem;
      position: relative;
      background: #1a1a1a;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .post-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
      position: relative;
    }
    
    .post-header .avatar {
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .post-header .avatar:hover {
      transform: scale(1.05);
    }
    
    .post-header .meta {
      flex: 1;
    }
    
    .post-header .author {
      font-weight: 600;
      color: white;
      text-decoration: none;
      transition: color 0.2s;
    }
    
    .post-header .author:hover {
      color: #1DA1F2;
    }
    
    .post-header .time {
      font-size: 0.85rem;
      color: #888;
      margin-top: 0.25rem;
    }
    
    .post-menu-btn:hover {
      background-color: rgba(255,255,255,0.1) !important;
    }
    
    .post-body {
      max-height: 300px;
      overflow-y: auto;
      padding: 1rem 0;
      margin: 1rem 0;
    }
    
    .post-actions {
      margin-top: auto;
      padding-top: 1rem;
      border-top: 1px solid #333;
    }
    
    /* Ensure posts fill the viewport */
    .center {
      height: calc(100vh - 80px);
      overflow: hidden;
      margin-left: 120px; 
      margin-right: 120px;
    }
    
    .create-post-panel {
      position: sticky;
      top: 0;
      z-index: 10;
      background: #1a1a1a;
    }
    
    /* Comments sidebar */
    .comments-sidebar {
      position: fixed;
      right: 0;
      top: 80px;
      width: 500px;
      height: calc(100vh - 80px);
      background: #1a1a1a;
      border-left: 1px solid #333;
      display: flex;
      flex-direction: column;
      z-index: 50;
      border-top-left-radius: 12px; 
      border-bottom-left-radius: 12px; 
    }
    
    .comments-sidebar-header {
      padding: 1rem;
      border-bottom: 1px solid #333;
      font-weight: 600;
      font-size: 1.1rem;
    }
    
    .comments-sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }
    
    .sidebar-comment {
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #333;
      position: relative;
    }
    
    .comment-menu-toggle {
      position: absolute;
      top: 0;
      right: 0;
      background: none;
      border: none;
      color: #888;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      transition: all 0.2s;
    }
    
    .comment-menu-toggle:hover {
      background-color: rgba(255,255,255,0.1);
      color: #fff;
    }
    
    .comment-dropdown {
      position: absolute;
      top: 30px;
      right: 0;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 0.5rem;
      min-width: 120px;
      z-index: 100;
      display: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    
    .comment-dropdown.visible {
      display: block;
    }
    
    .comment-dropdown button {
      display: block;
      width: 100%;
      padding: 0.5rem 0.75rem;
      background: none;
      border: none;
      color: white;
      text-align: left;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.2s;
      font-size: 0.9rem;
    }
    
    .comment-dropdown button:hover {
      background-color: rgba(255,255,255,0.1);
    }
    
    .comment-dropdown button.danger {
      color: #ef4444;
    }
    
    .comments-sidebar-form {
      padding: 1rem;
      border-top: 1px solid #333;
      display: flex;
      gap: 0.5rem;
    }
    
    .comments-sidebar-input {
      flex: 1;
      padding: 0.75rem;
      background: #2a2a2a;
      border: 1px solid #333;
      border-radius: 8px;
      color: white;
    }
    
    .comments-sidebar-submit {
      padding: 0.75rem 1.5rem;
      background: #1DA1F2;
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .comments-sidebar-submit:hover {
      background: #1a8cd8;
    }

    /* Main Layout - NEW DESIGN */
    .layout {
      max-width: 100%;
      margin: 0;
      padding: 0;
      display: grid;
      grid-template-columns: 320px 1fr 400px;
      gap: 0;
      align-items: start;
      height: 100vh;
      overflow: hidden;
      position: fixed;
      top: 80px;
      left: 0;
      right: 0;
      bottom: 0;
    }
    
    .left {
      height: 100%;
      overflow-y: auto;
      border-right: 1px solid #333;
    }
    
    .center {
      height: 100%;
      overflow: hidden;
      position: relative;
    }
    
    .right {
      height: 100%;
      overflow: hidden;
    }
    
    @media (max-width: 1024px) {
        .layout { 
          grid-template-columns: 1fr; 
        }
        .left .friends-section, .right { 
          display: none; 
        }
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Loading and end of feed states */
    .loading-indicator,
    .end-of-feed {
      scroll-snap-align: none;
      min-height: auto;
      max-height: none;
      padding: 1rem;
    }
    
    .empty-feed-message {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: calc(100vh - 80px);
      color: #888;
      font-size: 1.1rem;
      text-align: center;
      padding: 2rem;
    }
  </style>
</head>

<body>
  <header class="topbar">
  <div class="left-section">
    <button id="menuToggle" class="hamburger" aria-label="Open menu" aria-expanded="false" title="Menu">
      <span></span><span></span><span></span>
    </button>
    <a href="/pages/blacknote.html">
      <img src="/assets/blacknotetrans.png" alt="Logo" class="logo" />
    </a>
  </div>

  <div class="center-section">
    <div class="search-container">
      <input type="text" class="search-box" placeholder="Search..." />
    </div>
  </div>

<div class="right-section">

<a href="#" id="notification-bell-link" class="icon-btn" title="Notifications" style="margin-left: 15px; margin-right: 30px;">
    <img src="/assets/notif.png" alt="Notifications" class="custom-emoji">
</a>

<a href="/pages/blacknote.html" class="icon-btn" title="home">
    <img src="/assets/home.png" alt="home" class="custom-emoji">
  </a>
  <a href="/pages/friendsblacknote.html" class="icon-btn" title="Add">
    <img src="/assets/add.png" alt="Add" class="custom-emoji">
  </a>
  <a href="/pages/mapblacknote.html" class="icon-btn" title="Basketball">
    <img src="/assets/ball.png" alt="Basketball" class="custom-emoji">
  </a>
  <a href="/pages/dripblacknote.html" class="icon-btn" title="Black Market">
    <img src="/assets/shop.png" alt="Money" class="custom-emoji">
  </a>
  <a href="/pages/hollablacknote.html" class="icon-btn" title="Holla">
    <img src="/assets/hol.png" alt="Holla" class="custom-emoji">
  </a>
</div>

</header>

<nav id="slideMenu" class="slide-menu" aria-hidden="true" role="navigation">
  <div class="slide-menu-inner" role="menu" aria-label="Site menu">
    <button id="contactBtn" class="menu-item" role="menuitem">Contact Us!</button>
    <button id="aboutBtn" class="menu-item" role="menuitem">About</button>
    <button id="logoutBtn" class="menu-item login-btn" role="menuitem">Logout</button>
  </div>
</nav>
<div id="menuOverlay" class="menu-overlay" aria-hidden="true"></div>

  <div id="offline-banner" class="offline-banner">You are offline ‚Äî some features may be unavailable.</div>

<div class="layout">
  <!-- Left column -->
  <aside class="left">
    <div class="panel profile-center">
      <input id="pfp-upload" type="file" accept="image/*" style="display:none;">
      <div id="profile-pic" class="profile-pic" title="Profile picture (open Edit Profile to change)"></div>
      
      <!-- Badge next to username -->
      <div class="profile-header-with-badge">
        <div id="profile-badge-display"></div>
        <div class="profile-name main-profile-name">Black Note</div>
      </div>
      
      <div class="profile-bio" id="profile-bio">Stand-in bio: creative, coffee lover, building BlackNote.</div>
      
      <button class="post-btn edit-profile-btn" id="open-profile-editor">Edit Profile</button>
    </div>
    
    <!-- Create Post Button in Container -->
    <div class="create-post-button-container">
      <button class="create-post-compact-btn" id="open-create-post">
        ‚úèÔ∏è Create Post
      </button>
    </div>
    
    <!-- Friends moved under profile -->
    <div class="friends-section">
      <div class="panel">
        <h3>Friends</h3>
        <div class="friends-list" id="friends-container"></div>
      </div>
    </div>
  </aside>

  <!-- Center column -->
  <main class="center">
    <div class="feed" id="feed-container"></div>
  </main>

  <!-- Right column - Comments Sidebar -->
  <aside class="right">
    <div class="comments-sidebar">
      <div class="comments-sidebar-header">Comments</div>
      <div class="comments-sidebar-content" id="sidebar-comments-list">
        <p style="color: #888; text-align: center; padding: 2rem;">Select a post to view comments</p>
      </div>
      <form class="comments-sidebar-form" id="sidebar-comment-form" style="display: none;">
        <input type="text" class="comments-sidebar-input" placeholder="Add a comment..." id="sidebar-comment-input" required>
        <button type="submit" class="comments-sidebar-submit">Post</button>
      </form>
    </div>
  </aside>
</div>

<!-- Create Post Modal - FULLSCREEN -->
<div class="create-post-modal" id="create-post-modal" style="display: none;">
  <div class="create-post-modal-content" onclick="event.stopPropagation();">
    <div class="create-post-modal-header">
      <h2 class="create-post-modal-title">Create a New Post</h2>
      <button class="create-post-close-btn" id="close-create-modal" type="button">&times;</button>
    </div>
    <div class="create-post-modal-body">
      <textarea class="create-post-textarea" placeholder="What's on your mind?" id="new-post-text"></textarea>

      <div class="create-post-media">
        <label for="new-post-media" class="media-upload-btn">
          üìé Attach Media
        </label>
        <input type="file" id="new-post-media" accept="image/*,video/*" style="display:none;">
        <span id="file-name" class="file-name">No file chosen</span>
        <button id="remove-media" class="remove-media-btn" title="Remove file" type="button">‚úñ</button>
      </div>
      
      <div style="font-size: 0.85rem; color: #666; margin-top: -0.5rem; margin-bottom: 1rem;">
        üì∏ Images: Up to 50MB (auto-compressed) ‚Ä¢ üé• Videos: Max 10MB, 30sec
      </div>

      <div class="create-post-actions">
        <button class="create-post-cancel-btn" id="cancel-create-post" type="button">Cancel</button>
        <button class="post-btn" id="create-post-btn" type="button">Post</button>
      </div>
    </div>
  </div>
</div>

  <div id="profile-editor-modal" class="modal-overlay" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="profile-modal-title">
      <button class="close-modal-btn" id="close-modal" aria-label="Close" style="position:absolute; top:1rem; right:1rem; background:none; border:none; font-size:2rem; color:var(--muted); cursor:pointer;">&times;</button>
      <h2 id="profile-modal-title" style="margin-top:0;">Edit Profile</h2>
      <form id="profile-edit-form">
        <label for="pfp-upload-modal">Profile Picture</label>
        <label for="pfp-upload-modal" style="cursor:pointer;">
          <img id="pfp-preview" src="/assets/BN.png" alt="Profile preview">
        </label>
        <input type="file" id="pfp-upload-modal" accept="image/*" style="display:none;">

        <label for="username-input">Username</label>
        <input type="text" id="username-input" value="Black Note" autocomplete="off">
        <p id="username-cooldown-msg" aria-live="polite"></p>

        <label for="bio-input">Bio</label>
        <textarea id="bio-input" placeholder="Write a short bio..."></textarea>

        <!-- Badge Selection -->
        <label>Choose Your Badge</label>
        <div class="badge-selector" id="badge-selector">
          <div class="badge-option red" data-badge="red" title="Red Badge"></div>
          <div class="badge-option gold" data-badge="gold" title="Gold Badge"></div>
          <div class="badge-option blue" data-badge="blue" title="Blue Badge"></div>
          <div class="badge-option green" data-badge="green" title="Green Badge"></div>
          <div class="badge-option white" data-badge="white" title="White Badge"></div>
          <div class="badge-option black" data-badge="black" title="Black Badge"></div>
          <div class="badge-option pink" data-badge="pink" title="Pink Badge"></div>
        </div>

        <button type="submit" id="save-profile-btn" class="post-btn" style="width: 100%; margin-top: 1rem;">Save Changes</button>
      </form>
    </div>
  </div>

  <!-- Compression Progress Toast -->
  <div id="compression-toast" style="position: fixed; bottom: 20px; right: 20px; background: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 1rem 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.5); z-index: 10001; display: none;">
    <div style="display: flex; align-items: center; gap: 0.75rem;">
      <div class="spinner" style="width: 20px; height: 20px; border: 2px solid #333; border-top-color: #1DA1F2; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
      <div>
        <div style="font-weight: 600; color: white; margin-bottom: 0.25rem;" id="toast-title">Compressing media...</div>
        <div style="font-size: 0.875rem; color: #888;" id="toast-message">Please wait</div>
      </div>
    </div>
  </div>

```html
<script type="module">
  import { 
    supabase, 
    uploadImageForUser, 
    onAuthStateChanged, 
    startGlobalNotifications,
    getUserProfile,
    updateUserProfile
  } from '/javascript/supabase.js';

  // ---------------- Constants ----------------
  const COOLDOWN_HOURS = 24;
  const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB in bytes (final uploaded file limit)
  const MAX_VIDEO_SIZE = 10 * 1024 * 1024; // 10MB for videos (hard limit)
  const MAX_VIDEO_DURATION = 30; // 30 seconds max
  const MAX_IMAGE_SIZE_BEFORE_COMPRESSION = 50 * 1024 * 1024; // 50MB - will try to compress
  const IMAGE_MAX_DIMENSION = 1920; // max width/height during compression

  /*
   * üìä FILE UPLOAD GUARDRAILS
   * - Images: originals up to 50MB will be accepted and compressed in-browser to <= 10MB.
   * - Videos: browser compression is unreliable ‚Äî reject >10MB, enforce duration limit.
   * - Supabase counts only the bytes you upload, so compress BEFORE upload.
   */

  // ---------------- UI helpers (toast) ----------------
  function showToast(title, message) {
    const toast = document.getElementById('compression-toast');
    if (!toast) return;
    const toastTitle = document.getElementById('toast-title');
    const toastMessage = document.getElementById('toast-message');

    if (toastTitle) toastTitle.textContent = title;
    if (toastMessage) toastMessage.textContent = message;
    toast.style.display = 'block';
  }

  function hideToast() {
    const toast = document.getElementById('compression-toast');
    if (!toast) return;
    toast.style.display = 'none';
  }

  // ---------------- Image compression (Canvas) ----------------
  async function compressImage(file, maxSizeMB = 10) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();

      reader.onload = (e) => {
        const img = new Image();

        img.onload = () => {
          const canvas = document.createElement('canvas');
          let width = img.width;
          let height = img.height;

          // Resize preserving aspect ratio with a max dimension
          const maxDim = IMAGE_MAX_DIMENSION;
          if (width > maxDim || height > maxDim) {
            if (width > height) {
              height = Math.round((height * maxDim) / width);
              width = maxDim;
            } else {
              width = Math.round((width * maxDim) / height);
              height = maxDim;
            }
          }

          canvas.width = width;
          canvas.height = height;

          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);

          let quality = 0.92;

          const tryCompress = () => {
            canvas.toBlob(
              (blob) => {
                if (!blob) {
                  reject(new Error('Compression failed: blob is null'));
                  return;
                }

                const sizeMB = blob.size / (1024 * 1024);
                // console.log(`üìè Compressed to ${sizeMB.toFixed(2)}MB at quality ${quality}`);

                if (sizeMB <= maxSizeMB || quality <= 0.10) {
                  // Construct a File so upload functions can use it
                  const compressedFile = new File([blob], sanitizeFileName(file.name, 'jpg'), {
                    type: 'image/jpeg',
                    lastModified: Date.now()
                  });
                  resolve(compressedFile);
                } else {
                  quality = Math.max(quality - 0.12, 0.10);
                  // try again with slightly lower quality
                  tryCompress();
                }
              },
              'image/jpeg',
              quality
            );
          };

          tryCompress();
        };

        img.onerror = () => reject(new Error('Failed to load image during compression'));
        img.src = e.target.result;
      };

      reader.onerror = () => reject(new Error('Failed to read file for compression'));
      reader.readAsDataURL(file);
    });
  }

  function sanitizeFileName(name, forcedExt = null) {
    const base = name.replace(/[^a-zA-Z0-9.\-_]/g, '_');
    if (!forcedExt) return base;
    const dotIndex = base.lastIndexOf('.');
    const stem = dotIndex === -1 ? base : base.substring(0, dotIndex);
    return `${stem}.${forcedExt.replace(/^\./, '')}`;
  }

  // ---------------- Video property check ----------------
  async function checkVideoProperties(file) {
    return new Promise((resolve, reject) => {
      const video = document.createElement('video');
      video.preload = 'metadata';

      video.onloadedmetadata = () => {
        window.URL.revokeObjectURL(video.src);
        const duration = video.duration;
        resolve({
          duration: duration,
          valid: duration <= MAX_VIDEO_DURATION
        });
      };

      video.onerror = () => {
        reject(new Error('Failed to load video metadata'));
      };

      video.src = URL.createObjectURL(file);
    });
  }

  // ---------------- Process uploaded file (image/video) ----------------
  async function processUploadedFile(file) {
    console.log(`üìÅ Processing file: ${file.name} (${(file.size / (1024 * 1024)).toFixed(2)}MB)`);

    // Supported types: image/* and video/*
    if (!file.type.startsWith('image/') && !file.type.startsWith('video/')) {
      alert('Only images and videos are supported.');
      return null;
    }

    const sizeMB = (file.size / (1024 * 1024)).toFixed(2);

    // ---------- VIDEO flow ----------
    if (file.type.startsWith('video/')) {
      console.log('üé• Video detected - checking constraints...');

      // 1) Block if original file already larger than allowed hard limit
      if (file.size > MAX_VIDEO_SIZE) {
        hideToast();
        alert(
          `‚ùå Video is too large (${sizeMB}MB)\n\n` +
          `Maximum video size: ${(MAX_VIDEO_SIZE / (1024 * 1024)).toFixed(0)}MB\n\n` +
          `üí° Tips:\n` +
          `‚Ä¢ Compress or trim the video before uploading\n` +
          `‚Ä¢ Keep duration ‚â§ ${MAX_VIDEO_DURATION} seconds`
        );
        return null;
      }

      // 2) Check duration (metadata)
      showToast('Checking video...', 'Validating duration and size');
      try {
        const videoProps = await checkVideoProperties(file);
        hideToast();
        if (!videoProps.valid) {
          alert(
            `‚ùå Video is too long (${Math.round(videoProps.duration)}s)\n\n` +
            `Maximum duration: ${MAX_VIDEO_DURATION} seconds\n\n` +
            `Please trim your video and try again.`
          );
          return null;
        }
        // 3) Final size check (safety)
        if (file.size > MAX_FILE_SIZE) {
          alert(`‚ùå Video file is still too large (${sizeMB}MB). Maximum is ${MAX_FILE_SIZE / (1024 * 1024)}MB.`);
          return null;
        }
        console.log(`‚úÖ Video passed checks: ${videoProps.duration.toFixed(1)}s, ${sizeMB}MB`);
        return file; // ready for upload
      } catch (err) {
        console.error('‚ùå Video validation failed:', err);
        hideToast();
        alert('Failed to validate video. Please try a different file.');
        return null;
      }
    }

    // ---------- IMAGE flow ----------
    if (file.type.startsWith('image/')) {
      console.log('üñºÔ∏è Image detected - processing...');

      // Block absurdly large images
      if (file.size > MAX_IMAGE_SIZE_BEFORE_COMPRESSION) {
        hideToast();
        alert(
          `‚ùå Image is too large (${sizeMB}MB)\n\n` +
          `Maximum allowed before compression: ${(MAX_IMAGE_SIZE_BEFORE_COMPRESSION / (1024 * 1024)).toFixed(0)}MB\n\n` +
          `Please resize the image before uploading.`
        );
        return null;
      }

      // If the image is already <= MAX_FILE_SIZE, still run a quick optimization pass to reduce size
      // If > MAX_FILE_SIZE, we must compress down to <= MAX_FILE_SIZE
      try {
        // Show a toast for UX
        if (file.size > MAX_FILE_SIZE) {
          showToast('Compressing image...', `Original size: ${sizeMB}MB`);
        } else {
          showToast('Optimizing image...', `Size: ${sizeMB}MB`);
        }

        const compressed = await compressImage(file, MAX_FILE_SIZE / (1024 * 1024));
        hideToast();

        const newSizeMB = (compressed.size / (1024 * 1024)).toFixed(2);
        console.log(`‚úÖ Image compressed/optimized: ${sizeMB}MB ‚Üí ${newSizeMB}MB`);

        if (compressed.size > MAX_FILE_SIZE) {
          alert(
            `‚ùå Image is still too large after compression (${newSizeMB}MB)\n\n` +
            `Please choose a smaller image or reduce its resolution manually.`
          );
          return null;
        }

        return compressed;
      } catch (err) {
        console.error('‚ùå Compression failed:', err);
        hideToast();
        // As a fallback: if compression fails and original is <= limit, allow original; otherwise reject
        if (file.size <= MAX_FILE_SIZE) {
          console.warn('Using original image because compression failed but original is under limit.');
          return file;
        }
        alert('Failed to compress image. Please choose a smaller image.');
        return null;
      }
    }

    // Default fallback
    hideToast();
    alert('Unsupported file type.');
    return null;
  }

  // ---------------- Badge selection UI ----------------
  const badgeSelector = document.getElementById('badge-selector');
  const badgeDisplay = document.getElementById('profile-badge-display');
  let selectedBadge = null;
  let currentPostId = null; // Track currently visible post

  // ---------------- Create post modal refs ----------------
  let createPostBtn = null;
  let openCreatePostBtn = null;
  let createPostModal = null;
  let closeCreateModal = null;
  let cancelCreatePost = null;
  let createPostTextarea = null;
  let selectedMediaFile = null; // will hold the processed file
  let fileNameEl = null;

  function initCreatePostModal() {
    openCreatePostBtn = document.getElementById('open-create-post');
    createPostModal = document.getElementById('create-post-modal');
    closeCreateModal = document.getElementById('close-create-modal');
    cancelCreatePost = document.getElementById('cancel-create-post');
    createPostTextarea = document.getElementById('new-post-text');
    createPostBtn = document.getElementById('create-post-btn');
    const mediaInput = document.getElementById('new-post-media');
    const removeMediaBtn = document.getElementById('remove-media');
    fileNameEl = document.getElementById('file-name');

    console.log('üîß Create post elements initialized:', {
      button: !!openCreatePostBtn,
      modal: !!createPostModal,
      closeBtn: !!closeCreateModal,
      cancelBtn: !!cancelCreatePost,
      textarea: !!createPostTextarea,
      postBtn: !!createPostBtn
    });

    // Media selection handling
    if (mediaInput) {
      mediaInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        console.log(`üìé File selected: ${file.name}`);
        selectedMediaFile = null;
        fileNameEl && (fileNameEl.textContent = 'Processing...');

        const processedFile = await processUploadedFile(file);

        if (processedFile) {
          selectedMediaFile = processedFile;
          const sizeMB = (processedFile.size / (1024 * 1024)).toFixed(2);
          if (fileNameEl) {
            fileNameEl.textContent = `${processedFile.name} (${sizeMB}MB)`;
            fileNameEl.style.color = '#1DA1F2';
          }
          if (removeMediaBtn) removeMediaBtn.style.display = 'inline-block';
        } else {
          // Rejected
          if (mediaInput) mediaInput.value = '';
          selectedMediaFile = null;
          if (fileNameEl) {
            fileNameEl.textContent = 'No file chosen';
            fileNameEl.style.color = '';
          }
          if (removeMediaBtn) removeMediaBtn.style.display = 'none';
        }
      });
    }

    if (removeMediaBtn) {
      removeMediaBtn.addEventListener('click', () => {
        selectedMediaFile = null;
        const mediaInput = document.getElementById('new-post-media');
        if (mediaInput) mediaInput.value = '';
        if (fileNameEl) {
          fileNameEl.textContent = 'No file chosen';
          fileNameEl.style.color = '';
        }
        removeMediaBtn.style.display = 'none';
      });
    }

    if (openCreatePostBtn) {
      openCreatePostBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        openCreatePostModal();
      });
    }

    if (closeCreateModal) {
      closeCreateModal.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        closeCreatePostModal();
      });
    }

    if (cancelCreatePost) {
      cancelCreatePost.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        closeCreatePostModal();
      });
    }

    if (createPostModal) {
      createPostModal.addEventListener('click', (e) => {
        if (e.target === createPostModal) {
          closeCreatePostModal();
        }
      });
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && createPostModal && createPostModal.style.display === 'block') {
        closeCreatePostModal();
      }
    });

    // Create post button handler (example implementation)
    if (createPostBtn) {
      createPostBtn.addEventListener('click', async () => {
        const text = createPostTextarea ? createPostTextarea.value.trim() : '';
        if (!text && !selectedMediaFile) {
          alert('Please add text or media to create a post.');
          return;
        }
        createPostBtn.disabled = true;
        try {
          let media_url = null;
          let media_type = null;
          if (selectedMediaFile) {
            // uploadImageForUser expected to handle both images and videos (adjust as needed)
            media_url = await uploadImageForUser(selectedMediaFile, fbUser.id);
            media_type = selectedMediaFile.type.startsWith('video/') ? 'video' : 'image';
          }

          const postObj = {
            author: fbProfile?.name || fbUser.email,
            authorUid: fbUser.id,
            text,
            media_url,
            media_type,
            created_at: new Date().toISOString()
          };

          const { error } = await supabase.from('posts').insert(postObj);
          if (error) {
            console.error('Failed to create post:', error);
            alert('Failed to create post.');
          } else {
            // Optionally reload posts or prepend optimistically
            loadPosts();
            closeCreatePostModal();
          }
        } catch (err) {
          console.error('Error creating post:', err);
          alert('Failed to create post.');
        } finally {
          createPostBtn.disabled = false;
        }
      });
    }
  }

  function openCreatePostModal() {
    if (createPostModal) {
      createPostModal.style.display = 'block';
      setTimeout(() => {
        createPostModal.classList.add('visible');
        createPostTextarea && createPostTextarea.focus();
      }, 10);
    }
  }

  function closeCreatePostModal() {
    if (createPostModal) {
      createPostModal.classList.remove('visible');
      setTimeout(() => {
        createPostModal.style.display = 'none';
      }, 200);
    }
    if (createPostTextarea) createPostTextarea.value = '';
    if (fileNameEl) fileNameEl.textContent = 'No file chosen';
    const mediaInput = document.getElementById('new-post-media');
    if (mediaInput) mediaInput.value = '';
    const removeMediaBtn = document.getElementById('remove-media');
    if (removeMediaBtn) removeMediaBtn.style.display = 'none';
    selectedMediaFile = null;
  }

  // ---------------- Badge UI ----------------
  if (badgeSelector) {
    badgeSelector.addEventListener('click', (e) => {
      const option = e.target.closest('.badge-option');
      if (!option) return;

      badgeSelector.querySelectorAll('.badge-option').forEach(b => b.classList.remove('selected'));
      option.classList.add('selected');
      selectedBadge = option.dataset.badge;
    });
  }

  function displayBadge(badgeColor, targetElement = badgeDisplay) {
    if (!targetElement) return;
    if (!badgeColor) {
      targetElement.innerHTML = '';
      return;
    }
    const badgeImg = document.createElement('img');
    badgeImg.className = 'profile-badge-small';
    badgeImg.src = `/assets/badges/${badgeColor}.png`;
    badgeImg.alt = `${badgeColor} badge`;
    badgeImg.onerror = () => {
      const fallback = document.createElement('div');
      fallback.className = 'profile-badge-small';
      fallback.style.backgroundColor = badgeColor === 'white' ? '#f3f4f6' : badgeColor;
      targetElement.innerHTML = '';
      targetElement.appendChild(fallback);
    };
    targetElement.innerHTML = '';
    targetElement.appendChild(badgeImg);
  }

  // ---------------- Feed scroll + intersection helpers ----------------
  function setupScrollSnap() {
    const feedEl = document.getElementById('feed-container');
    if (!feedEl) return;

    let scrollTimeout;
    let isScrolling = false;

    feedEl.addEventListener('scroll', () => {
      isScrolling = true;
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(() => {
        isScrolling = false;
        detectCurrentPost();
      }, 100);
    });

    const posts = feedEl.querySelectorAll('.post');
    const observerOptions = {
      root: feedEl,
      threshold: 0.5
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting && !isScrolling) {
          const postId = entry.target.dataset.postId;
          if (postId !== currentPostId) {
            currentPostId = postId;
            loadCommentsForPost(postId);
          }
        }
      });
    }, observerOptions);

    posts.forEach(post => observer.observe(post));
  }

  function setupInfiniteScroll() {
    const feedEl = document.getElementById('feed-container');
    if (!feedEl) return;
    const loadingIndicator = feedEl.querySelector('.loading-indicator');
    if (!loadingIndicator) return;

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting && hasMorePosts && !isLoadingMore) {
          loadMorePosts();
        }
      });
    }, {
      root: feedEl,
      threshold: 0.1,
      rootMargin: '100px'
    });

    observer.observe(loadingIndicator);
  }

  function detectCurrentPost() {
    const feedEl = document.getElementById('feed-container');
    if (!feedEl) return;
    const postsEls = feedEl.querySelectorAll('.post');
    let currentPost = null;
    let minDistance = Infinity;
    postsEls.forEach(post => {
      const rect = post.getBoundingClientRect();
      const feedRect = feedEl.getBoundingClientRect();
      const distance = Math.abs(rect.top - feedRect.top);
      if (distance < minDistance) {
        minDistance = distance;
        currentPost = post;
      }
    });
    if (currentPost) {
      const postId = currentPost.dataset.postId;
      if (postId !== currentPostId) {
        currentPostId = postId;
        loadCommentsForPost(postId);
      }
    }
  }

  // ---------------- Comments loader ----------------
  async function loadCommentsForPost(postId) {
    const post = findPostById(postId);
    if (!post) return;

    const commentsList = document.getElementById('sidebar-comments-list');
    const commentForm = document.getElementById('sidebar-comment-form');
    const commentInput = document.getElementById('sidebar-comment-input');

    if (!commentsList || !commentForm) return;
    commentsList.innerHTML = '';
    commentForm.style.display = 'flex';
    commentForm.dataset.postId = postId;

    if (!post.comments || post.comments.length === 0) {
      commentsList.innerHTML = '<p style="color: #888; text-align: center; padding: 2rem;">No comments yet. Be the first!</p>';
      return;
    }

    post.comments.forEach(comment => {
      if (!comment) return;
      const commentDiv = document.createElement('div');
      commentDiv.className = 'sidebar-comment';
      commentDiv.dataset.commentId = comment.id;

      const header = document.createElement('div');
      header.style.display = 'flex';
      header.style.alignItems = 'center';
      header.style.gap = '0.5rem';
      header.style.marginBottom = '0.5rem';
      header.style.paddingRight = '2rem';

      const avatar = avatarElement(comment.author, comment.avatar, 32);
      avatar.style.flexShrink = '0';
      header.appendChild(avatar);

      const author = document.createElement('div');
      author.style.fontWeight = '600';
      author.style.color = 'white';
      author.textContent = comment.author;
      header.appendChild(author);

      commentDiv.appendChild(header);

      const text = document.createElement('p');
      text.className = 'comment-text-content';
      text.style.color = '#ddd';
      text.style.margin = '0';
      text.style.wordBreak = 'break-word';
      text.textContent = comment.text;
      commentDiv.appendChild(text);

      // Permissions & menu (edit/delete)
      const isCommentAuthor = fbUser && (comment.authorUid ? comment.authorUid === fbUser.uid : (fbProfile && comment.author === fbProfile.name));
      const isPostAuthor = fbUser && (post.authorUid ? post.authorUid === fbUser.uid : (fbProfile && post.author === fbProfile.name));

      if (isCommentAuthor || isPostAuthor) {
        const menuToggle = document.createElement('button');
        menuToggle.className = 'comment-menu-toggle';
        menuToggle.innerHTML = '‚ãÆ';
        const dropdown = document.createElement('div');
        dropdown.className = 'comment-dropdown';

        if (isCommentAuthor) {
          const editBtn = document.createElement('button');
          editBtn.textContent = 'Edit';
          editBtn.addEventListener('click', async () => {
            const newText = prompt('Edit your comment:', comment.text);
            if (newText === null || newText.trim() === '') return;
            try {
              const { data: postData } = await supabase
                .from('posts')
                .select('comments')
                .eq('id', postId)
                .single();
              if (!postData) return;
              const updatedComments = (postData.comments || []).map(c =>
                c.id === comment.id ? { ...c, text: newText.trim() } : c
              );
              await supabase
                .from('posts')
                .update({ comments: updatedComments })
                .eq('id', postId);
              dropdown.classList.remove('visible');
            } catch (err) {
              console.error('‚ùå Failed to edit comment:', err);
              alert('Failed to update comment.');
            }
          });
          dropdown.appendChild(editBtn);
        }

        if (isCommentAuthor || isPostAuthor) {
          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'danger';
          deleteBtn.textContent = 'Delete';
          deleteBtn.addEventListener('click', async () => {
            if (!confirm('Delete this comment?')) return;
            try {
              const { data: postData } = await supabase
                .from('posts')
                .select('comments')
                .eq('id', postId)
                .single();
              if (!postData) return;
              const updatedComments = (postData.comments || []).filter(c => c.id !== comment.id);
              await supabase
                .from('posts')
                .update({ comments: updatedComments })
                .eq('id', postId);
              dropdown.classList.remove('visible');
            } catch (err) {
              console.error('‚ùå Failed to delete comment:', err);
              alert('Failed to delete comment.');
            }
          });
          dropdown.appendChild(deleteBtn);
        }

        menuToggle.addEventListener('click', (e) => {
          e.stopPropagation();
          document.querySelectorAll('.comment-dropdown.visible').forEach(d => {
            if (d !== dropdown) d.classList.remove('visible');
          });
          dropdown.classList.toggle('visible');
        });

        commentDiv.appendChild(menuToggle);
        commentDiv.appendChild(dropdown);
      }

      commentsList.appendChild(commentDiv);
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.sidebar-comment')) {
        document.querySelectorAll('.comment-dropdown.visible').forEach(d => d.classList.remove('visible'));
      }
    });
  }

  // ---------------- Notifications + auth state ----------------
  let authUnsubscribe = null;
  const feedEl = document.getElementById('feed-container');
  const friendsEl = document.getElementById('friends-container');
  const profilePicEl = document.getElementById('profile-pic');
  const profileBioEl = document.getElementById('profile-bio');

  const profileModal = document.getElementById('profile-editor-modal');
  const pfpPreview = document.getElementById('pfp-preview');
  const pfpUploadModal = document.getElementById('pfp-upload-modal');
  const usernameInput = document.getElementById('username-input');
  const bioInput = document.getElementById('bio-input');
  const saveProfileBtn = document.getElementById('save-profile-btn');
  const openProfileEditorBtn = document.getElementById('open-profile-editor');
  const offlineBanner = document.getElementById('offline-banner');

  let notificationPanel = null;
  let notificationBadge = null;
  let notifications = [];
  let lastSeenPostIds = new Set();
  let postsSubscription = null;
  let notificationInitTime = null;

  function loadNotificationState() {
    try {
      const saved = localStorage.getItem('notificationState');
      if (saved) {
        const state = JSON.parse(saved);
        lastSeenPostIds = new Set(state.lastSeenPostIds || []);
        notificationInitTime = state.initTime || null;
        notifications = (state.notifications || []).filter(n => (Date.now() - n.timestamp) < (60 * 60 * 1000));
      } else {
        notificationInitTime = Date.now();
        saveNotificationState();
      }
    } catch (err) {
      console.error('Failed to load notification state:', err);
      notificationInitTime = Date.now();
    }
  }

  function saveNotificationState() {
    try {
      const state = {
        lastSeenPostIds: Array.from(lastSeenPostIds),
        initTime: notificationInitTime,
        notifications: notifications
      };
      localStorage.setItem('notificationState', JSON.stringify(state));
    } catch (err) {
      console.error('Failed to save notification state:', err);
    }
  }

  // ---------------- Runtime state ----------------
  let fbUser = null;
  let fbProfile = null;
  let posts = [];
  let profileUnsub = null;
  let friendsUnsub = null;

  // Pagination state
  let currentPage = 0;
  const POSTS_PER_PAGE = 20;
  let isLoadingMore = false;
  let hasMorePosts = true;

  // ---------------- Helpers ----------------
  function escapeHtml(str) {
    if (!str) return '';
    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  function avatarElement(name, imgUrl, size = 48) {
    const wrapper = document.createElement('div');
    wrapper.className = 'avatar';
    wrapper.style.width = size + 'px';
    wrapper.style.height = size + 'px';
    if (imgUrl && String(imgUrl).startsWith('http')) {
      const img = document.createElement('img');
      img.src = imgUrl;
      img.alt = name || '';
      img.style.width = '100%';
      img.style.height = '100%';
      img.style.objectFit = 'cover';
      img.style.borderRadius = '50%';
      img.style.display = 'block';
      wrapper.style.overflow = 'hidden';
      wrapper.style.borderRadius = '50%';
      wrapper.innerHTML = '';
      wrapper.appendChild(img);
    } else {
      wrapper.textContent = (name && name[0]) ? name[0].toUpperCase() : '?';
    }
    return wrapper;
  }

  function findPostById(id) {
    return posts.find(p => p.id === id);
  }

  function checkUsernameCooldownUI(profileObj) {
    const last = profileObj?.last_username_change ? new Date(profileObj.last_username_change).getTime() : null;
    const cooldownMsgEl = document.getElementById('username-cooldown-msg');
    if (!last) {
      usernameInput && (usernameInput.disabled = false);
      if (cooldownMsgEl) cooldownMsgEl.textContent = '';
      return;
    }
    const hoursPassed = (Date.now() - last) / (1000 * 60 * 60);
    if (hoursPassed < COOLDOWN_HOURS) {
      const hoursLeft = Math.ceil(COOLDOWN_HOURS - hoursPassed);
      usernameInput && (usernameInput.disabled = true);
      if (cooldownMsgEl) cooldownMsgEl.textContent = `You can change your username again in ${hoursLeft} hour(s).`;
    } else {
      usernameInput && (usernameInput.disabled = false);
      if (cooldownMsgEl) cooldownMsgEl.textContent = '';
    }
  }

  // ---------------- Rendering ----------------
  function renderFeed(array, append = false) {
    if (!feedEl) return;
    console.log('üé® Rendering feed with', array.length, 'posts', append ? '(appending)' : '(replacing)');
    if (!append) feedEl.innerHTML = '';
    else {
      const loadingIndicator = feedEl.querySelector('.loading-indicator');
      if (loadingIndicator) loadingIndicator.remove();
    }

    const hiddenKey = fbUser ? `hiddenPosts_${fbUser.id}` : 'hiddenPosts_guest';
    const hiddenPosts = JSON.parse(localStorage.getItem(hiddenKey) || '[]');
    const visible = (array || []).filter(p => !hiddenPosts.includes(p.id));
    console.log('üëÅÔ∏è Visible posts after filtering:', visible.length);

    if (!visible.length && !append) {
      const d = document.createElement('div');
      d.className = 'empty-feed-message';
      d.textContent = 'No posts yet ‚Äî add friends to bring your feed to life!';
      feedEl.appendChild(d);
      return;
    }

    visible.forEach(post => {
      const article = document.createElement('article');
      article.className = 'post';
      article.dataset.postId = post.id;

      // header
      const header = document.createElement('div');
      header.className = 'post-header';
      const avatarWrap = avatarElement(post.author_name || post.author || '', post.author_avatar || null, 48);
      avatarWrap.addEventListener('click', () => {
        location.href = `profileblacknote.html?user=${encodeURIComponent(post.author_name || post.author || '')}`;
      });
      header.appendChild(avatarWrap);

      const meta = document.createElement('div');
      meta.className = 'meta';
      const authorLink = document.createElement('a');
      authorLink.className = 'author';
      authorLink.href = `profileblacknote.html?user=${encodeURIComponent(post.author_name || post.author || '')}`;
      authorLink.textContent = post.author_name || post.author || 'Unknown';
      meta.appendChild(authorLink);
      const tdiv = document.createElement('div');
      tdiv.className = 'time';
      tdiv.textContent = post.display_time || (post.created_at ? new Date(post.created_at).toLocaleString() : '');
      meta.appendChild(tdiv);
      header.appendChild(meta);

      article.appendChild(header);

      // Post menu
      const postMenu = document.createElement('div');
      postMenu.className = 'post-menu';
      postMenu.style.position = 'absolute';
      postMenu.style.top = '1rem';
      postMenu.style.right = '1rem';

      const menuBtn = document.createElement('button');
      menuBtn.className = 'post-menu-btn';
      menuBtn.innerHTML = '‚ãÆ';
      menuBtn.style.cssText = 'background: none; border: none; color: #888; font-size: 1.5rem; cursor: pointer; padding: 0.5rem; border-radius: 4px; transition: all 0.2s;';

      const dropdown = document.createElement('div');
      dropdown.className = 'post-menu-dropdown';
      dropdown.style.cssText = 'position: absolute; right: 0; top: 100%; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 0.5rem; min-width: 120px; display: none; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.5);';

      const hideBtn = document.createElement('button');
      hideBtn.textContent = 'Hide Post';
      hideBtn.style.cssText = 'display: block; width: 100%; padding: 0.5rem 0.75rem; background: none; border: none; color: white; text-align: left; cursor: pointer; border-radius: 4px; transition: background-color 0.2s;';
      hideBtn.addEventListener('click', () => {
        const hiddenKey = fbUser ? `hiddenPosts_${fbUser.id}` : 'hiddenPosts_guest';
        const hidden = JSON.parse(localStorage.getItem(hiddenKey) || '[]');
        hidden.push(post.id);
        localStorage.setItem(hiddenKey, JSON.stringify(hidden));
        article.remove();
        dropdown.style.display = 'none';
      });
      hideBtn.addEventListener('mouseenter', () => hideBtn.style.backgroundColor = 'rgba(255,255,255,0.1)');
      hideBtn.addEventListener('mouseleave', () => hideBtn.style.backgroundColor = 'transparent');
      dropdown.appendChild(hideBtn);

      const isAuthor = fbUser && (post.authorUid ? post.authorUid === fbUser.uid : (fbProfile && (post.author === fbProfile.name || post.author_name === fbProfile.name)));

      if (isAuthor) {
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Delete Post';
        deleteBtn.style.cssText = 'display: block; width: 100%; padding: 0.5rem 0.75rem; background: none; border: none; color: #ef4444; text-align: left; cursor: pointer; border-radius: 4px; transition: background-color 0.2s;';
        deleteBtn.addEventListener('click', async () => {
          if (!confirm('Delete this post?')) return;
          try {
            await supabase.from('posts').delete().eq('id', post.id);
            article.remove();
            dropdown.style.display = 'none';
          } catch (err) {
            console.error('Failed to delete post:', err);
            alert('Failed to delete post.');
          }
        });
        deleteBtn.addEventListener('mouseenter', () => deleteBtn.style.backgroundColor = 'rgba(255,255,255,0.1)');
        deleteBtn.addEventListener('mouseleave', () => deleteBtn.style.backgroundColor = 'transparent');
        dropdown.appendChild(deleteBtn);
      }

      menuBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        document.querySelectorAll('.post-menu-dropdown').forEach(d => {
          if (d !== dropdown) d.style.display = 'none';
        });
        dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
      });

      postMenu.appendChild(menuBtn);
      postMenu.appendChild(dropdown);
      header.appendChild(postMenu);

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.post-menu')) {
          dropdown.style.display = 'none';
        }
      });

      // body
      const body = document.createElement('div');
      body.className = 'post-body';
      const textP = document.createElement('p');
      textP.textContent = post.text || '';
      body.appendChild(textP);
      article.appendChild(body);

      // media
      if (post.media_url) {
        const mediaDiv = document.createElement('div');
        mediaDiv.className = 'post-media';
        if (post.media_type === 'video') {
          const vid = document.createElement('video');
          vid.src = post.media_url;
          vid.controls = true;
          vid.style.maxWidth = '100%';
          vid.style.borderRadius = '8px';
          mediaDiv.appendChild(vid);
        } else {
          const img = document.createElement('img');
          img.src = post.media_url;
          img.alt = 'Post image';
          img.style.maxWidth = '100%';
          img.style.borderRadius = '8px';
          mediaDiv.appendChild(img);
        }
        article.appendChild(mediaDiv);
      }

      // actions
      const actions = document.createElement('div');
      actions.className = 'post-actions';
      actions.style.cssText = 'display: flex; gap: 1rem; align-items: center; margin-top: auto; padding-top: 1rem; border-top: 1px solid #333;';

      const likeBtn = document.createElement('button');
      likeBtn.className = 'action-btn like-btn';
      likeBtn.innerHTML = `üëç ${post.likes || 0}`;
      likeBtn.style.cssText = 'background: none; border: none; color: #888; font-size: 1rem; cursor: pointer; padding: 0.5rem 1rem; border-radius: 8px; transition: all 0.2s; display: flex; align-items: center; gap: 0.5rem;';
      likeBtn.addEventListener('mouseenter', () => likeBtn.style.backgroundColor = 'rgba(255,255,255,0.1)');
      likeBtn.addEventListener('mouseleave', () => likeBtn.style.backgroundColor = 'transparent');
      actions.appendChild(likeBtn);

      const dislikeBtn = document.createElement('button');
      dislikeBtn.className = 'action-btn dislike-btn';
      dislikeBtn.innerHTML = `üëé ${post.dislikes || 0}`;
      dislikeBtn.style.cssText = 'background: none; border: none; color: #888; font-size: 1rem; cursor: pointer; padding: 0.5rem 1rem; border-radius: 8px; transition: all 0.2s; display: flex; align-items: center; gap: 0.5rem;';
      dislikeBtn.addEventListener('mouseenter', () => dislikeBtn.style.backgroundColor = 'rgba(255,255,255,0.1)');
      dislikeBtn.addEventListener('mouseleave', () => dislikeBtn.style.backgroundColor = 'transparent');
      actions.appendChild(dislikeBtn);

      const commentBtn = document.createElement('button');
      commentBtn.className = 'action-btn';
      commentBtn.innerHTML = `üí¨ ${(post.comments || []).length}`;
      commentBtn.style.cssText = 'background: none; border: none; color: #888; font-size: 1rem; cursor: pointer; padding: 0.5rem 1rem; border-radius: 8px; transition: all 0.2s; display: flex; align-items: center; gap: 0.5rem;';
      commentBtn.addEventListener('mouseenter', () => commentBtn.style.backgroundColor = 'rgba(255,255,255,0.1)');
      commentBtn.addEventListener('mouseleave', () => commentBtn.style.backgroundColor = 'transparent');
      commentBtn.addEventListener('click', () => {
        currentPostId = post.id;
        loadCommentsForPost(post.id);
      });
      actions.appendChild(commentBtn);

      article.appendChild(actions);
      feedEl.appendChild(article);
    });

    // loading indicator or end message
    if (hasMorePosts && visible.length > 0) {
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'loading-indicator';
      loadingDiv.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: center; padding: 2rem; gap: 0.75rem;">
          <div class="spinner" style="width: 24px; height: 24px; border: 3px solid #333; border-top-color: #1DA1F2; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
          <span style="color: #888;">Loading more posts...</span>
        </div>
      `;
      feedEl.appendChild(loadingDiv);
    } else if (!hasMorePosts && visible.length > 0) {
      const endDiv = document.createElement('div');
      endDiv.className = 'end-of-feed';
      endDiv.innerHTML = `
        <div style="text-align: center; padding: 2rem; color: #888;">
          <p style="margin: 0;">üéâ You're all caught up!</p>
          <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">No more posts to show</p>
        </div>
      `;
      feedEl.appendChild(endDiv);
    }

    if (!append) {
      setupScrollSnap();
      setupInfiniteScroll();
    }
  }

  function renderFriends(friendsList) {
    if (!friendsEl) return;
    friendsEl.innerHTML = '';
    if (!friendsList || friendsList.length === 0) {
      friendsEl.innerHTML = '<p style="color:#888;">No friends yet.</p>';
      return;
    }
    friendsList.forEach(fr => {
      const item = document.createElement('div');
      item.className = 'friend-item';
      const av = avatarElement(fr.name, fr.avatar, 40);
      item.appendChild(av);
      const nameDiv = document.createElement('div');
      nameDiv.style.flex = '1';
      nameDiv.style.fontWeight = '500';
      nameDiv.textContent = fr.name;
      item.appendChild(nameDiv);
      friendsEl.appendChild(item);
    });
  }

  // ---------------- Init on DOM ready ----------------
  document.addEventListener('DOMContentLoaded', () => {
    console.log('üìÑ DOM loaded, initializing...');
    initCreatePostModal();
    loadNotificationState();
  });

  // ---------------- Auth monitoring ----------------
  onAuthStateChanged(async (user) => {
    fbUser = user;
    if (!user) {
      console.log('‚ùå No user, redirecting to login');
      window.location.href = '/pages/loginblacknote.html';
      return;
    }

    console.log('‚úÖ User authenticated:', user.email);
    const profile = await getUserProfile(user.id);
    fbProfile = profile;

    if (profile) {
      // Set profile picture
      if (profile.avatar) {
        if (profilePicEl) {
          profilePicEl.style.backgroundImage = `url(${profile.avatar})`;
          profilePicEl.style.backgroundSize = 'cover';
          profilePicEl.style.backgroundPosition = 'center';
        }
      } else if (profilePicEl) {
        profilePicEl.style.backgroundImage = '';
        profilePicEl.textContent = (profile.name && profile.name[0]) ? profile.name[0].toUpperCase() : '?';
        profilePicEl.style.display = 'flex';
        profilePicEl.style.alignItems = 'center';
        profilePicEl.style.justifyContent = 'center';
        profilePicEl.style.fontSize = '3rem';
        profilePicEl.style.fontWeight = '700';
        profilePicEl.style.color = 'white';
      }

      if (profileBioEl) profileBioEl.textContent = profile.bio || 'No bio yet.';
      const mainNameEl = document.querySelector('.main-profile-name');
      if (mainNameEl) mainNameEl.textContent = profile.name || user.email;

      if (pfpPreview) pfpPreview.src = profile.avatar || '/assets/BN.png';
      if (usernameInput) usernameInput.value = profile.name || '';
      if (bioInput) bioInput.value = profile.bio || '';

      if (profile.badge) {
        selectedBadge = profile.badge;
        displayBadge(profile.badge);
        const option = badgeSelector && badgeSelector.querySelector(`[data-badge="${profile.badge}"]`);
        if (option) option.classList.add('selected');
      }

      checkUsernameCooldownUI(profile);
    }

    console.log('üìä Performance: Loading posts with pagination (20 at a time)');
    loadPosts();
    loadFriends();
  });

  // ---------------- Load posts + pagination ----------------
  async function loadPosts() {
    console.log('üì• Loading initial posts (0-19)...');
    currentPage = 0;
    hasMorePosts = true;

    const startIndex = 0;
    const endIndex = POSTS_PER_PAGE - 1;

    const { data, error } = await supabase
      .from('posts')
      .select('*')
      .order('created_at', { ascending: false })
      .range(startIndex, endIndex);

    if (error) {
      console.error('‚ùå Failed to load posts:', error);
      return;
    }

    posts = data || [];
    console.log(`‚úÖ Loaded ${posts.length} posts`);

    if (posts.length < POSTS_PER_PAGE) {
      hasMorePosts = false;
      console.log('üì≠ No more posts available');
    }

    renderFeed(posts, false);
  }

  async function loadMorePosts() {
    if (isLoadingMore || !hasMorePosts) return;
    isLoadingMore = true;
    currentPage++;

    const startIndex = currentPage * POSTS_PER_PAGE;
    const endIndex = startIndex + POSTS_PER_PAGE - 1;

    console.log(`üì• Loading more posts (${startIndex}-${endIndex})...`);

    const { data, error } = await supabase
      .from('posts')
      .select('*')
      .order('created_at', { ascending: false })
      .range(startIndex, endIndex);

    if (error) {
      console.error('‚ùå Failed to load more posts:', error);
      isLoadingMore = false;
      return;
    }

    const newPosts = data || [];
    console.log(`‚úÖ Loaded ${newPosts.length} more posts`);

    if (newPosts.length < POSTS_PER_PAGE) {
      hasMorePosts = false;
      console.log('üì≠ Reached end of posts');
    }

    posts = [...posts, ...newPosts];
    renderFeed(newPosts, true);
    isLoadingMore = false;

    if (hasMorePosts) {
      setupInfiniteScroll();
    }
  }

  async function loadFriends() {
    if (!fbUser) return;
    const { data, error } = await supabase
      .from('friends')
      .select('friend_id, profiles(name, avatar)')
      .eq('user_id', fbUser.id);

    if (error) {
      console.error('Failed to load friends:', error);
      return;
    }

    const friendsList = (data || []).map(f => ({
      id: f.friend_id,
      name: f.profiles?.name || 'Unknown',
      avatar: f.profiles?.avatar || null
    }));

    renderFriends(friendsList);
  }

  // ---------------- Profile editor ----------------
  const openProfileEditor = document.getElementById('open-profile-editor');
  if (openProfileEditor) {
    openProfileEditor.addEventListener('click', () => {
      if (profileModal) {
        profileModal.setAttribute('aria-hidden', 'false');
        profileModal.style.display = 'flex';
      }
    });
  }

  const closeModalBtn = document.getElementById('close-modal');
  if (closeModalBtn) {
    closeModalBtn.addEventListener('click', () => {
      if (profileModal) {
        profileModal.setAttribute('aria-hidden', 'true');
        profileModal.style.display = 'none';
      }
    });
  }

  if (pfpUploadModal) {
    pfpUploadModal.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (ev) => {
          if (pfpPreview) pfpPreview.src = ev.target.result;
        };
        reader.readAsDataURL(file);
      }
    });
  }

  const profileEditForm = document.getElementById('profile-edit-form');
  if (profileEditForm) {
    profileEditForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!fbUser) return;

      const newUsername = usernameInput ? usernameInput.value.trim() : '';
      const newBio = bioInput ? bioInput.value.trim() : '';

      let avatarUrl = fbProfile?.avatar || null;
      const file = pfpUploadModal ? pfpUploadModal.files[0] : null;
      if (file) {
        // Optional: process avatar file similarly to compress/limit
        const processed = await processUploadedFile(file);
        if (!processed) {
          alert('Avatar upload failed or was rejected.');
          return;
        }
        avatarUrl = await uploadImageForUser(processed, fbUser.id);
      }

      const updates = {
        name: newUsername,
        bio: newBio,
        avatar: avatarUrl,
        badge: selectedBadge
      };

      if (newUsername !== fbProfile?.name) {
        const canChange = await checkUsernameCooldown(fbProfile);
        if (!canChange) {
          alert('You must wait 24 hours between username changes.');
          return;
        }
        updates.last_username_change = new Date().toISOString();
      }

      await updateUserProfile(fbUser.id, updates);
      fbProfile = { ...fbProfile, ...updates };

      if (profilePicEl) profilePicEl.style.backgroundImage = avatarUrl ? `url(${avatarUrl})` : '';
      if (profileBioEl) profileBioEl.textContent = newBio || 'No bio yet.';
      const mainNameEl = document.querySelector('.main-profile-name');
      if (mainNameEl) mainNameEl.textContent = newUsername || fbUser.email;

      displayBadge(selectedBadge);

      if (profileModal) {
        profileModal.setAttribute('aria-hidden', 'true');
        profileModal.style.display = 'none';
      }

      alert('Profile updated!');
    });
  }

  async function checkUsernameCooldown(profileObj) {
    if (!profileObj?.last_username_change) return true;
    const lastChange = new Date(profileObj.last_username_change).getTime();
    const hoursPassed = (Date.now() - lastChange) / (1000 * 60 * 60);
    return hoursPassed >= COOLDOWN_HOURS;
  }

  // ---------------- Menu + logout ----------------
  const menuToggle = document.getElementById('menuToggle');
  const slideMenu = document.getElementById('slideMenu');
  const menuOverlay = document.getElementById('menuOverlay');

  if (menuToggle) {
    menuToggle.addEventListener('click', () => {
      slideMenu && slideMenu.classList.add('open');
      menuOverlay && menuOverlay.classList.add('visible');
    });
  }

  if (menuOverlay) {
    menuOverlay.addEventListener('click', () => {
      slideMenu && slideMenu.classList.remove('open');
      menuOverlay && menuOverlay.classList.remove('visible');
    });
  }

  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = '/pages/loginblacknote.html';
    });
  }

  // ---------------- Offline detection ----------------
  window.addEventListener('online', () => {
    if (offlineBanner) offlineBanner.style.display = 'none';
  });

  window.addEventListener('offline', () => {
    if (offlineBanner) offlineBanner.style.display = 'block';
  });
</script>

</body>
</html>
